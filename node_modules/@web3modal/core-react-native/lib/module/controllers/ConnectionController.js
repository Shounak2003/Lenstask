import { subscribeKey as subKey } from 'valtio/utils';
import { proxy, ref } from 'valtio/vanilla';
import { CoreHelperUtil } from '../utils/CoreHelperUtil';
import { StorageUtil } from '../utils/StorageUtil';

// -- Types --------------------------------------------- //

// -- State --------------------------------------------- //
const state = proxy({
  wcError: false
});

// -- Controller ---------------------------------------- //
export const ConnectionController = {
  state,
  subscribeKey(key, callback) {
    return subKey(state, key, callback);
  },
  _getClient() {
    if (!state._client) {
      throw new Error('ConnectionController client not set');
    }
    return state._client;
  },
  setClient(client) {
    state._client = ref(client);
  },
  connectWalletConnect() {
    state.wcPromise = this._getClient().connectWalletConnect(uri => {
      state.wcUri = uri;
      state.wcPairingExpiry = CoreHelperUtil.getPairingExpiry();
    });
  },
  resetWcConnection() {
    state.wcUri = undefined;
    state.wcPairingExpiry = undefined;
    state.wcPromise = undefined;
    state.wcLinking = undefined;
    state.pressedWallet = undefined;
    StorageUtil.deleteWalletConnectDeepLink();
  },
  setWcLinking(wcLinking) {
    state.wcLinking = wcLinking;
  },
  removeWcLinking() {
    state.wcLinking = undefined;
  },
  setWcError(wcError) {
    state.wcError = wcError;
  },
  setPressedWallet(wallet) {
    state.pressedWallet = wallet;
  },
  removePressedWallet() {
    state.pressedWallet = undefined;
  },
  setRecentWallets(wallets) {
    state.recentWallets = wallets;
  },
  async disconnect() {
    await this._getClient().disconnect();
    this.resetWcConnection();
  }
};
//# sourceMappingURL=ConnectionController.js.map